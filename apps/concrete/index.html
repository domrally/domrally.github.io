<!doctype html>
<html>
    <head>
        <title>concrete by Dom Mandy</title>
        <meta name="description" content="lightweight brutalist markup">
        <meta name="keywords" content="concrete, app, Dom, Mandy">
        <link href="favicon.ico" rel="shortcut icon">
        <link href="app.css" rel="stylesheet" media="screen">
        <script type="text/javascript" src="https://rawgit.com/patriciogonzalezvivo/glslCanvas/master/dist/GlslCanvas.js"></script>
    </head>
    <body>
        <header>
            <span class="styled">\ <span class="highlight">concrete</span></span>
            <br>
            <span class="styled">+ <span class="bold">lightweight brutalist markup</span></span>
            <br>
            <span class="styled">/ <span class="italics">try typing in the box below</span></span>
        </header>
        <main>
<!--
            <section class="downloads">
                =save.txt
                <script>
                    const save = document.currentScript.parentElement;
                    save.onclick = function saveFile(){
                        var text = save.nextElementSibling.innerText,
                            blob = new Blob([text], { type: 'text/plain' }),
                            anchor = document.createElement('a');
                        anchor.download = "save.txt";
                        anchor.href = (window.webkitURL || window.URL).createObjectURL(blob);
                        anchor.dataset.downloadurl = ['text/plain', anchor.download, anchor.href].join(':');
                        anchor.click();
                    }
                </script>
            </section>
-->
            <section contenteditable>
                normal<br>
                >code<br>
                |quote<br>
                @https://www.dommandy.com/apps/concrete<br>
                #anchor<br>
                /italics<br>
                -strike-through<br>
                _underline<br>
                +bold<br>
                \highlight<br>
                <script>
                    // Select the node that will be observed for mutations
                    const editor = document.currentScript.parentElement;
                    // Options for the observer (which mutations to observe)
                    const config = 
                    { 
                        attributes: true,
                        characterData: true, 
                        subtree: true,  
                    };
                    const appendElement = (word) => 
                    {
                        const key = word.charAt();
                        let className = "";
                        let id = "";
                        let tagName = null;
                        let href = null;
                        switch (key) 
                        {
                            case '@':
                                className = "link";
                                tagName = "a";
                                href = word.slice(1);
                                break;
                            case '#':
                                className = "anchor";
                                tagName = "a";
                                href = word;
                                id = word.slice(1);
                                break;
                            case '/':
                                className = "italics";
                                tagName = "span";
                                break;
                            case '-':
                                className = "strikethrough";
                                tagName = "span";
                                break;
                            case '_':
                                className = "underline";
                                tagName = "span";
                                break;
                            case '>':
                                tagName = "code";
                                break;
                            case '|':
                                tagName = "blockquote"
                                break;
                            case '+':
                                className = "bold";
                                tagName = "span";
                                break;
                            case '\\':
                                className = "highlight";
                                tagName = "span";
                                break;
                            default:
                                break;
                        }
                        if (tagName)
                        {
                            const element = document.createElement(tagName);
                            element.className = className;
                            element.id = id;
                            element.href = href;
                            const keyElement = document.createElement("span");
                            keyElement.className = "styled";
                            keyElement.append(key);
                            editor.append(keyElement);
//                            parent.append(element);
                            element.append(word.slice(1));
                            if (href)
                            {
                                element.ondblclick = () => 
                                {
                                    const anchor = document.createElement('a');
                                    anchor.href = href;
                                    anchor.click();
                                };
                            }
                            editor.append(element);
                        }
                        else
                        {
                            editor.append(word);
                        }
                    };
                    // Callback function to execute when mutations are observed
                    const onMutate = (mutationsList, observer) => 
                    {
//                        let count = 0;
//                        for(let el of editor.children)
//                        {         
//                            if (el.textContent === window.getSelection().anchorNode.textContent)
//                            {
//                                count += window.getSelection().anchorOffset;
//                                break;
//                            }
//                            count += el.innerText.length;
//                        }
//                        console.log(count);
//                        const selection = window.getSelection().anchorOffset;
//                        console.log(selection);
                        const text = editor.innerText;
                        editor.innerHTML = "";
                        const lines = text.split('\n');
//                        const chunk = "";
                        for(let line of lines) 
                        {
                            if (line !== lines[0]) editor.append(document.createElement("br"));
                            const words = line.split(' ');
//                            if (word[0] === "")
                            for(let word of words) 
                            {
//                                chunk += word;
//                                const span = document.createElement("span");
                                appendElement(word);
//                                editor.append(element);
                            }
                        }
//                        let newCount = 0;
//                        for(let el of editor.children)
//                        {         
//                            newCount += el.innerText.length;
//                            if (newCount > count)
//                            {
//                                window.getSelection().collapse(el, selection);
//                            }
//                        }
                    };
                    // Create an observer instance linked to the callback function
                    const observer = new MutationObserver(onMutate);
                    // Start observing the target node for configured mutations
                    observer.observe(editor, config);
                    editor.focus();
                    onMutate(null, null);
                </script>
            </section>
            <canvas class="top left" data-fragment-url="../../shaders/superRectTopLeft.frag" width="32" height="32">
                <script>
                    var canvas = document.currentScript.parentElement;
                    var sandbox = new GlslCanvas(canvas);
                    sandbox.pause();                    
                </script>
            </canvas>
            <canvas class="bottom left" data-fragment-url="../../shaders/superRectBottomLeft.frag" width="32" height="32">
                <script>
                    var canvas = document.currentScript.parentElement;
                    var sandbox = new GlslCanvas(canvas);
                    sandbox.pause();                    
                </script>
            </canvas>
            <canvas class="top right" data-fragment-url="../../shaders/superRectTopRight.frag" width="32" height="32">
                <script>
                    var canvas = document.currentScript.parentElement;
                    var sandbox = new GlslCanvas(canvas);
                    sandbox.pause();                    
                </script>
            </canvas>
            <canvas class="right bottom" data-fragment-url="../../shaders/superRectBottomRight.frag" width="32" height="32">
                <script>
                    var canvas = document.currentScript.parentElement;
                    var sandbox = new GlslCanvas(canvas);
                    sandbox.pause();                    
                </script>
            </canvas>
        </main>
    </body>
</html>