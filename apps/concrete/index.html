<!doctype html>
<html>
    <head>
        <title>concrete by Dom Mandy</title>
        <meta name="description" content="lightweight brutalist markup">
        <meta name="keywords" content="concrete, app, Dom, Mandy">
        <link href="favicon.ico" rel="shortcut icon">
        <link href="app.css" rel="stylesheet" media="screen">
        <script type="text/javascript" src="https://rawgit.com/patriciogonzalezvivo/glslCanvas/master/dist/GlslCanvas.js"></script>
    </head>
    <body>
        <canvas class="background" data-fragment-url="../../shaders/rectbow.frag" width="720" height="720">
            <script src="../../js/drawShader.js"></script>
        </canvas>
        <main class="column">
            <section contenteditable>
                +concrete<br>
                <br>
                | lightweight brutalist markup<br>
                try editing any of this text<br>
                <br>
                plain<br>
                >code<br>
                |quote<br>
                @https://www.dommandy.com/apps/concrete<br>
                #anchor<br>
                +bold<br>
                \highlight<br>
                <script>
                    // Select the node that will be observed for mutations
                    const editor = document.currentScript.parentElement;
                    // Options for the observer (which mutations to observe)
                    const config = 
                    { 
                        attributes: true,
                        childList: true,
                        characterData: true, 
                        subtree: true,  
                    };
                    const appendElement = (word) => 
                    {
                        word += ' ';
                        const key = word.charAt();
                        const value = word.slice(1);
                        let className = "";
                        let id = "";
                        let tagName = null;
                        let href = null;
                        let aria = "true";
                        switch (key) 
                        {
                            case '@':
                                className = "link";
                                tagName = "a";
                                href = word.slice(1);
                                break;
                            case '#':
                                className = "anchor";
                                tagName = "a";
                                href = word;
                                id = word.slice(1);
                                break;
                            case '>':
                                tagName = "code";
                                break;
                            case '|':
                                tagName = "blockquote"
                                break;
                            case '+':
                                className = "bold";
                                tagName = "span";
                                break;
                            case '\\':
                                className = "highlight";
                                tagName = "span";
                                break;
                            default:
                                aria = "undefined";
                                break;
                        }
                        let wordElement = word;
                        if (tagName)
                        {
                            const keyElement = document.createElement("span");
                            keyElement.className = "styled";
    //                            keyElement.aria-hidden = aria;
                            keyElement.append(key);

                            const valueElement = document.createElement(tagName);
                            valueElement.className = className;
                            valueElement.id = id;
                            valueElement.href = href;                            
                            valueElement.append(value);

                            if (href)
                            {
                                valueElement.ondblclick = () => 
                                {
                                    const anchor = document.createElement('a');
                                    anchor.href = href;
                                    anchor.click();
                                };
                            }

                            wordElement = document.createElement('span');
                            wordElement.append(keyElement);
                            wordElement.append(valueElement);
                        }
                        return wordElement;
                    };
                    // Callback function to execute when mutations are observed
                    const onMutate = (mutationsList, observer) => 
                    {
                        if (observer) observer.disconnect();

                        const selectedOffset = window.getSelection().anchorOffset;

                        const anchorNode = window.getSelection().anchorNode;
                        const editorTree = editor.firstChild;
                        let depth = 0;
                        let height = 0;
                        let count = 0;
                        const findAnchor = (node) => 
                        {
                            while (node)
                            {
                                count++;
                                if (node === anchorNode)
                                {
                                    return true;
                                }
                                if (node.firstChild)
                                {
                                    depth++;
                                    if (findAnchor(node.firstChild)) return true;
                                }
                                node = node.nextSibling;
                                height++;
                            }
                            depth--;
                            return false;
                        }
                        findAnchor(editorTree);

                        const text = editor.innerText;
                        editor.innerHTML = "";
                        const lines = text.split('\n');
                        for(let line of lines) 
                        {
                            const lineElement = document.createElement('div');
                            const words = line.split(' ');
                            for(let word of words) 
                            {
                                const wordElement = appendElement(word);
                                lineElement.append(wordElement);
                            }
                            
                            editor.append(lineElement);
                        }
                        let counter = 0;
                        const seekAnchor = (node) => 
                        {
                            while (node)
                            {
                                counter++;
                                if (count === counter)
                                {
                                    window.getSelection().removeAllRanges();
                                    if (node.textContent.length >= selectedOffset) window.getSelection().collapse(node, selectedOffset);
                                    return true;
                                }
                                if (node.firstChild)
                                {
                                    if (seekAnchor(node.firstChild)) return true;
                                }
                                node = node.nextSibling;
                            }
                            return false;
                        }
                        seekAnchor(editor.firstChild);
                        if (observer) observer.observe(editor, config);
                    };
                    // Create an observer instance linked to the callback function
                    const observer = new MutationObserver(onMutate);
                    // Start observing the target node for configured mutations
                    observer.observe(editor, config);
                    editor.focus();
                    onMutate(null, null);
                </script>
            </section>
            <canvas class="top left" data-fragment-url="../../shaders/superRectTopLeft.frag" width="32" height="32">
                <script src="../../js/drawShader.js"></script>
            </canvas>
            <canvas class="bottom left" data-fragment-url="../../shaders/superRectBottomLeft.frag" width="32" height="32">
                <script src="../../js/drawShader.js"></script>
            </canvas>
            <canvas class="top right" data-fragment-url="../../shaders/superRectTopRight.frag" width="32" height="32">
                <script src="../../js/drawShader.js"></script>
            </canvas>
            <canvas class="right bottom" data-fragment-url="../../shaders/superRectBottomRight.frag" width="32" height="32">
                <script src="../../js/drawShader.js"></script>
            </canvas>
        </main>
    </body>
</html>